import{B as de,p as l,D as pe,J as i,R as ne,w as ke,t as n,v as e,K as Re,L as _e,M as I,N as v,O as g,P as se,I as oe,Q as A,S as f,T as le,U as Fe,z as y}from"./index-fe3cbde7.js";import{M as Me}from"./index-90ebf0d9.js";import{d as z}from"./dayjs.min-eaaee9a3.js";import{r as ze,u as Te,C as je,e as re,a as Le,b as Be,L as P,M as ce,c as Ee}from"./index-2b360347.js";import{P as Ie}from"./PageDesc-9e3ec0fe.js";import{H as Ae}from"./Helmet-cbe4fd85.js";import{S as Pe}from"./SoundOutlined-07ae4e1c.js";const $e=async r=>{try{return(await pe.get(r)).data}catch(c){throw console.error("Fetch error:",c),c}},ie=async([r,c])=>{try{return(await pe.post(r,c)).data}catch(a){throw console.error("Fetch error:",a),a}},Oe=(r,c,a)=>{const{data:d,error:x,mutate:C}=de(`/iblog/message/list?page=${r}&&pageSize=${c}&&auditStatus=${a}`,$e,{revalidateOnFocus:!1});return{messageBoardList:d,isMessageBoradListFetched:!x&&d!==void 0,mutate:C}},Ze=()=>{const{data:r,error:c}=de(null,ie,{revalidateOnFocus:!1,revalidateOnReconnect:!1,shouldRetryOnError:!1});return{handleMessageBoard:l.useCallback(async d=>d?await ie(["/iblog/message/insert",d]):void 0,[]),addMessageBoard:r,isAddMessageBoradFetched:!c&&r!==void 0}},Ke=()=>{const[r,c]=l.useState([]),[a,d]=l.useState({_id:"",pid:"-1"}),[x,C]=l.useState(1),[$,me]=l.useState(10),[k,ue]=l.useState(1),[he]=l.useState("cm"),[b]=i.useForm(),[R]=i.useForm(),w=l.useRef(null),[u,O]=l.useState(),[T,Z]=l.useState(!1),[j,H]=l.useState(!1);z.extend(ze);const L=ne.useRef(null),Y=ne.useRef(null),[B,q]=l.useState(""),[E,D]=l.useState("");l.useEffect(()=>{L.current&&window.scroll({top:L.current.offsetTop-80||0,left:0,behavior:"smooth"})},[]),l.useEffect(()=>{if(localStorage.getItem("zhj")==="success"&&localStorage.getItem("yychuiyan")!==null){const s=ke(localStorage.getItem("yychuiyan"));O(s)}else O(null)},[]);const{messageBoardList:p,isMessageBoradListFetched:_,mutate:V}=Oe(x,$,1),U=_&&p&&p.data?p.data:"";l.useEffect(()=>{_&&c(p.data.data)},[_,p,U]);const{totalCount:ge}=U,{addMessageBoard:S,isAddMessageBoradFetched:W,handleMessageBoard:J}=Ze(),F=_&&p&&p.data?p.data.data:"";F&&F.forEach(t=>t.children.sort((s,m)=>{s.messageTime-m.messageTime}));const{sendEmail:fe,isSendEmailFetched:K,handleSendEmail:Q}=Te();l.useEffect(()=>{K&&console.log("")},[fe,K]),l.useEffect(()=>{if(W)if(S.res&&S.res.pid==="-1")c(t=>[S.res,...t]);else{const t=F&&F.find(s=>s._id===S.res.pid);t?(t.children.push(S.res),console.log("找到父留言：",t)):console.error("未找到对应的留言"),c(s=>[t,...s])}},[W]);const ye=async t=>{if(t.content===void 0||t.content==="")return y.warning("留言不能为空哦！");y.success("留言成功！");try{const s={pid:a.pid,targetReplayId:a._id||"-1",targetReplayContent:"",currentReplayContent:t.content,auditTime:0,auditStatus:"1",avatar:u&&u.avatar,email:t.email,nickName:t.nickname};await J(s),setTimeout(async()=>{C(1),k===1&&R.resetFields(),k===2&&(d({_id:"",pid:"-1"}),b.resetFields());const m="haoju.zhang@outlook.com",h=`您的博客收到来自${t.nickname}<${t.email}>的留言`,N=`<div><br /><p>您在<span style="color: cadetblue; padding: 3px">夜雨炊烟</span>博客上收到新的留言</p><hr /><span style="color: cadetblue;">${t.nickname}:</span><p style="width: 98%;min-height: 30px;padding-top: 10px;padding-left: 10px;padding-bottom: 10px;background-color: #f5f5f5;border-radius: 10px;"><span>${t.content}</span></p><p><a href="https://yychuiyan.com/message"target="_blank"style="text-decoration: none; color: #5c8fef">点击查看详情</a></p></div>`.split(`
`).join(`
<br/>
`);await Q({email:m,subject:h,html:N}),V()},500)}catch{y.error("留言失败，请重试！")}},G=()=>{},X=t=>{d(t),b.resetFields(),w&&setTimeout(()=>{var s;(s=w==null?void 0:w.current)==null||s.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})},100)},xe=async t=>{if(t.content===void 0||t.content==="")return y.warning("回复内容不能为空哦！");y.success("回复成功！"),ue(2);const s={pid:a.pid==="-1"?a._id:a.pid,targetReplayId:a._id||"-1",targetReplayContent:`${t==null?void 0:t.nickname}@${a==null?void 0:a.nickName} ${a==null?void 0:a.currentReplayContent}`,currentReplayContent:t.content,auditTime:0,auditStatus:"1",avatar:u&&u.avatar,email:t.email,nickName:t.nickname};await J(s),setTimeout(async()=>{k===1&&R.resetFields(),k===2&&(d({_id:"",pid:"-1"}),b.resetFields());const m=a.email,h="您在夜雨炊烟小站中的留言收到了回复",N=`<div><br /><p>您在<span style="color: cadetblue; padding: 3px">夜雨炊烟</span>博客中的留言：</p><hr /><p style="width: 98%;min-height: 30px;padding-top: 10px;padding-left: 10px;padding-bottom: 10px;background-color: #f5f5f5;border-radius: 10px;"><span>${a.currentReplayContent}</span></p>收到<span style="color: cadetblue; padding-right:2px;">${t.nickname}</span>的回复:<p style="width: 98%;min-height: 30px;padding-top: 10px;padding-left: 10px;padding-bottom: 10px;background-color: #f5f5f5;border-radius: 10px;"><span>${t.content}</span></p><p><a href="https://yychuiyan.com/message"target="_blank"style="text-decoration: none; color: #5c8fef">点击查看详情</a></p></div>`.split(`
`).join(`
<br/>
`);await Q({email:m,subject:h,html:N}),V()},500),ee()},ee=()=>{d({_id:"",pid:"-1"})},be=(t,s)=>{C(t),me(s),window.scroll({top:Y.current.offsetTop+180||0,left:0,behavior:"smooth"})},we=t=>{R.setFieldsValue({content:B.concat(t)}),q(B.concat(t)),Z(!T)},Se=t=>{q(t.target.value)},Ne=t=>{b.setFieldsValue({content:E.concat(t)}),D(E.concat(t)),H(!j)},ve=t=>{D(t.target.value)},Ce=`name: 夜雨炊烟
link: https://yychuiyan.com
avatar: https://op.yychuiyan.com/avatar.webp
desc: 三餐烟火暖，四季皆安然。`;return n("div",{className:"w-1200 mx-auto pb-5 lg:w-full lg:mx-5 sm:w-[calc(100%-40px)]",ref:L,children:[e(Ae,{children:e("title",{children:"留言板 | 夜雨炊烟"})}),e(Ie,{title:"留言板"}),e("div",{className:"w-1000 mx-auto mt-10 lg:w-full",children:n(je,{className:" rounded-2xl bg-base-100",children:[e("div",{style:{textAlign:"center",fontSize:"16px",fontWeight:"bolder",marginBottom:"24px",position:"relative"},className:"lg:w-full sm:w-full",children:e("div",{className:"h-36 px-20 mt-5 font-normal lg:px-0 lg:mt-1",children:n("div",{className:"flex flex-col items-start w-[100%]  absolute",children:[e("p",{className:"flex absolute text-xl",style:{userSelect:"none"},children:"本站信息:"}),n("div",{className:"flex items-start relative justify-center flex-col w-800 mt-8 bg-base-200  rounded-xl hover:transition hover:duration-500 hover:shadow cursor-pointer lg:w-full",style:{userSelect:"none"},children:[e("p",{className:"absolute right-2 top-2",onClick:()=>{navigator.clipboard.writeText(Ce),y.info({content:"复制成功!",icon:e(Pe,{style:{color:"var(--bgcolor-social-default)"}}),className:"text-[var(--bgcolor-social-default)]"})},children:e(Re,{icon:_e,size:"xl"})}),n("p",{className:"pl-2 py-1",children:[e("span",{children:"name: "}),e("span",{children:"夜雨炊烟"})]}),n("p",{className:"pl-2 pb-1",children:[e("span",{children:"link: "}),e("span",{children:"https://yychuiyan.com"})]}),n("p",{className:"pl-2 pb-1 lg:flex lg:flex-col lg:items-start",children:[e("span",{children:"avatar: "}),e("span",{children:"https://op.yychuiyan.com/avatar.webp"})]}),n("p",{className:"pl-2 pb-1",children:[e("span",{children:"desc: "}),e("span",{children:"三餐烟火暖，四季皆安然。"})]})]})]})})}),n(i,{name:"basic",form:R,onFinish:ye,onFinishFailed:G,className:"w-800 mx-auto  lg:w-full sm:w-full",children:[n(I,{children:[e(v,{span:12,className:"pr-2 mt-5 lg:mt-8",children:e(i.Item,{label:"",name:"nickname",rules:[{required:!0,message:"请输入你的昵称"},{whitespace:!0,message:"输入不能为空"},{min:2,message:"昵称不能小于2个字符"},{max:30,message:"主题不能大于30个字符"}],children:e(g,{maxLength:30,placeholder:"请输入你的昵称"})})}),e(v,{span:12,className:"pl-2 mt-5 lg:mt-8",children:e(i.Item,{label:"",name:"email",rules:[{required:!0,message:"请输入你的邮箱"},{pattern:/^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9]{2,6}$/,message:"邮箱格式不正确"}],children:e(g,{maxLength:30,placeholder:"请输入你的邮箱"})})})]}),e(i.Item,{label:"",name:"content",children:e(g.TextArea,{placeholder:"请输入留言内容",onChange:Se,value:B,autoSize:{minRows:6,maxRows:12}})}),e(se,{overlayStyle:{width:"280px"},placement:"top",open:T,onOpenChange:()=>Z(!T),content:re.map(t=>e("span",{className:"inline-block cursor-pointer px-2 text-[20px] hover:bg-blue-400 w-5 h-8 rounded-md",onClick:()=>we(t.emoji),children:t.emoji},t.id)),children:n("div",{className:"-mt-5 mb-1 flex items-center justify-center w-16 h-8 text-center rounded cursor-pointer border-1 border-solid border-base-200",style:{userSelect:"none"},children:[e("span",{children:e(oe,{iconName:"icon-biaoqing",className:"text-[20px] text-[var(--color-icon-default)] pr-1"})}),e("span",{className:"text-[var(--color-icon-default)]",style:{userSelect:"none"},children:"表情"})]})}),e(i.Item,{className:"",children:n(A,{type:"primary",htmlType:"submit",className:"w-800 mx-auto lg:w-full sm:w-full",children:[e(Le,{})," 提交留言"]})})]}),e(I,{className:"mt:h-4 w-full mx-auto lg:w-full sm:w-full",ref:Y,children:n(v,{span:24,className:"sm:w-full lg:w-full",children:[n("b",{style:{marginBottom:"24px",color:"var(--color-icon-default)",userSelect:"none"},children:["留言展示 ",e(Be,{})]}),r&&r.length>0?e(P,{itemLayout:"horizontal",className:"sm:w-full lg:w-full",dataSource:r&&r,renderItem:(t,s)=>{var m,h;return e(P.Item,{actions:[],children:e(P.Item.Meta,{avatar:t.nickName.trim()==="夜雨炊烟"?e(f,{style:{userSelect:"none"},src:"https://op.yychuiyan.com/avatar1511.webp"}):t.avatar?e(f,{style:{userSelect:"none"},src:t.avatar}):e(f,{style:{backgroundColor:"#1890ff",userSelect:"none"},children:(h=(m=t.nickName)==null?void 0:m.slice(0,1))==null?void 0:h.toUpperCase()}),title:e("b",{style:{color:"var(--color-icon-default)",userSelect:"none"},children:t.nickName}),description:n(le,{children:[e("div",{className:"user_content font-normal lg:w-full",children:e("pre",{className:"whitespace-normal overflow-auto",dangerouslySetInnerHTML:{__html:t.currentReplayContent.replace(/((http|https):\/\/[-A-Za-z0-9+&@#/%?=~_|!:,.;]+[-A-Za-z0-9+&@#/%=~_|])/g,o=>"<a href='"+o+"' target='_blank'>"+o+"</a>")}})}),n("div",{className:"sm:w-full lg:w-full",style:{fontSize:"12px",marginTop:"8px",marginBottom:"16px",alignItems:"center",display:"flex",flexWrap:"wrap",justifyContent:"space-between"},children:[n("span",{className:"user_desc",style:{userSelect:"none"},children:["用户 ",t.nickName,"  发表于 ",z(t.messageTime*1e3).format("YYYY-MM-DD HH:mm:ss")]}),e("span",{style:{userSelect:"none"},children:n("a",{style:{fontSize:"12px",marginRight:"12px"},onClick:()=>X(t),children:[e(ce,{}),"  回复"]})})]}),t.children&&t.children.length?e(le,{children:t.children.map((o,N)=>{var M,te;return e(Ee,{className:"bg-base-100",author:e("span",{className:"replay_title",style:{userSelect:"none"},children:o.targetReplayContent.substring(0,40)+"···"}),avatar:o.nickName.trim()==="夜雨炊烟"?e(f,{style:{userSelect:"none"},src:"https://op.yychuiyan.com/avatar1511.webp"}):o.avatar?e(f,{style:{userSelect:"none"},src:o.avatar}):e(f,{style:{backgroundColor:"#1890ff",userSelect:"none"},children:(te=(M=o.nickName)==null?void 0:M.slice(0,1))==null?void 0:te.toUpperCase()}),content:e("span",{className:"user_content font-normal",children:e("pre",{className:"whitespace-normal overflow-auto",dangerouslySetInnerHTML:{__html:o.currentReplayContent.replace(/((http|https):\/\/[-A-Za-z0-9+&@#/%?=~_|!:,.;]+[-A-Za-z0-9+&@#/%=~_|])/g,ae=>"<a href='"+ae+"' target='_blank'>"+ae+"</a>")}})}),datetime:e(Fe,{title:o.messageTime,children:e("span",{style:{userSelect:"none"},children:z(z(o.messageTime*1e3).format("YYYY-MM-DD HH:mm:ss")).fromNow()})}),actions:[n("a",{style:{fontSize:"12px",marginRight:"12px",userSelect:"none"},onClick:()=>X(o),children:[e(ce,{}),"  回复"]})]},N)})}):null,a._id===t._id||a.pid===t._id?e("div",{style:{marginTop:"12px"},ref:w,children:n(i,{form:b,name:"reply",onFinish:xe,onFinishFailed:G,children:[n(I,{children:[e(v,{span:12,className:"pr-2",children:e(i.Item,{label:"",name:"nickname",rules:[{required:!0,message:"请输入你的昵称"},{whitespace:!0,message:"输入不能为空"},{min:2,message:"昵称不能小于2个字符"},{max:30,message:"主题不能大于30个字符"}],children:e(g,{maxLength:30,placeholder:"请输入你的昵称"})})}),e(v,{span:12,className:"pl-2",children:e(i.Item,{label:"",name:"email",rules:[{required:!0,message:"请输入你的邮箱"},{pattern:/^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9]{2,6}$/,message:"邮箱格式不正确"}],children:e(g,{maxLength:30,placeholder:"请输入你的邮箱"})})})]}),e(i.Item,{label:"",name:"content",children:e(g.TextArea,{placeholder:"请输入回复内容",onChange:ve,value:E,autoSize:{minRows:6,maxRows:12}})}),e(se,{overlayStyle:{width:"280px"},placement:"top",open:j,onOpenChange:()=>H(!j),content:re.map(o=>e("span",{className:" inline-block cursor-pointer px-2 text-[20px] hover:bg-blue-400 w-5 h-8 rounded-md",onClick:()=>Ne(o.emoji),children:o.emoji},o.id)),children:n("div",{className:"-mt-5 mb-1 flex items-center justify-center w-16 h-8 text-center rounded cursor-pointer border-1 border-solid border-base-200",style:{userSelect:"none"},children:[e("span",{children:e(oe,{iconName:"icon-biaoqing",className:"text-[20px] text-[var(--color-icon-default)] pr-1"})}),e("span",{className:"text-[var(--color-icon-default)]",children:"表情"})]})}),e(i.Item,{children:n("div",{style:{display:"flex",justifyContent:"flex-end"},children:[e(A,{style:{marginRight:"12px"},onClick:()=>ee(),children:"取消"}),e(A,{type:"primary",htmlType:"submit",children:" 回复"})]})}),e(i.Item,{})]})}):null]})})},s)}}):e("div",{className:"flex justify-center",children:"暂无留言~"}),e(Me,{text:he,pageSize:$,currentPage:x,total:ge,onChange:be})]})})]})})]})};export{Ke as default};
